#!/usr/bin/env bash
# Load personal standard shell library
# shellcheck source=/dev/null
if [[ -r ~/etc/lib.bash ]]; then . ~/etc/lib.bash; else echo "FATAL ERROR: ~/etc/lib.bash not found." ; exit 1 ; fi
need_progs brew rsync

bottle_root=~/Library/Caches/build_core

cd "$bottle_root" || fatal "Can't cd into $bottle_root"
mkdir -p .done

for j in */*.json; do
  [[ -s $j ]] || continue
  d="${j%/*}"
  jq -r '.[].bottle|(.tags|.[]|"\(.local_filename) \(.filename)"),(.root_url)' "$j" | while read -r lf rf; do
    read -r root_url
    #printf '[%30s] %50s -> %50s (%s)\n' "$d" "$lf" "$rf" "$root_url"
    #echo "[$d] $lf -> $rf"
    if [[ $root_url =~ https://github.com/([^/]*/[^/]*)/.* ]]; then
      real_ghrepo="${BASH_REMATCH[1]}"
    else
      warn "Unable to determine GH repo, skipping $d"
      continue
    fi
    rf=${rf//%40/@}
    [[ -s "$d/$lf" ]] && cmd mv -v "$d/$lf" "$d/$rf"
    tag=${root_url##*/}
    if cmd gh release view "$tag" -R "$real_ghrepo" >&/dev/null; then
      # Release already created
      cmd gh release upload "$tag" "$d/$rf" -R "$real_ghrepo" --clobber
    else
      # We need to create it with this new file
      cmd gh release create "$tag" "$d/$rf" -R "$real_ghrepo"
    fi && 
    cmd brew bottle --merge --write "$j" &&
    cmd rsync -avm "$d"/ .done/"$d"/ && 
    cmd rm -fr "$d"
  done
done
